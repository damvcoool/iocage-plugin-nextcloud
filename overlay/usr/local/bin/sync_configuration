#!/bin/sh

set -eu

# Source logging helper if available
if [ -f /usr/local/bin/log_helper ]; then
    . /usr/local/bin/log_helper
else
    # Fallback logging functions if log_helper not available
    log_info() { echo "[INFO] $*"; }
    log_step_start() { echo ">>> Starting: $*"; }
    log_step_end() { echo "<<< Finished: $*"; }
    log_warn() { echo "[WARN] $*"; }
fi

log_step_start "sync_configuration"

. load_env

NGINX_CONFD_PATH=/usr/local/etc/nginx/conf.d
OCPS_CONF="${NGINX_CONFD_PATH}/ocps-stapling.conf"
CERT_PATH=/usr/local/etc/letsencrypt/live/truenas

# Copy PostgreSQL configuration if it exists and data directory is available
log_info "Checking PostgreSQL configuration..."
if [ -f /root/config/postgresql.conf ]; then
    # Find the PostgreSQL data directory (supports different PostgreSQL versions)
    PG_DATA_DIR=""
    for pg_data_dir in /var/db/postgres/data* ; do
        # Check if glob expanded to an actual directory (not the literal pattern)
        if [ -d "$pg_data_dir" ]; then
            PG_DATA_DIR="$pg_data_dir"
            break
        fi
    done
    
    if [ -n "$PG_DATA_DIR" ]; then
        cp /root/config/postgresql.conf "${PG_DATA_DIR}/postgresql.conf" 2>/dev/null || true
        log_info "PostgreSQL configuration copied to ${PG_DATA_DIR}"
    else
        log_info "PostgreSQL data directory not found (database may not be initialized yet)"
    fi
else
    log_info "No custom PostgreSQL configuration found"
fi

# Copy Redis configuration if it exists and service is enabled
log_info "Checking Redis configuration..."
if [ -f /root/config/redis.conf ]; then
    cp /root/config/redis.conf /usr/local/etc/redis.conf 2>/dev/null || true
    log_info "Redis configuration copied"
else
    log_info "No custom Redis configuration found"
fi

# Two cases:
# - Nextcloud is accessed through <domain_name>: use port 443
# - Nextcloud is accessed through <ip>:<port>: use port $IOCAGE_HOST_PORT_HTTPS
export NEXTCLOUD_HTTPS_PORT=443

# Check if we have Let's Encrypt certificates by examining the certificate issuer
# This avoids calling certbot which logs debug messages on every invocation
# Match various Let's Encrypt certificate authorities (R3, E1, etc.) and ISRG Root
has_letsencrypt_cert() {
    [ -f "${CERT_PATH}/fullchain.pem" ] && \
        openssl x509 -in "${CERT_PATH}/fullchain.pem" -issuer -noout 2>/dev/null | grep -qiE "Let's Encrypt|ISRG Root"
}

log_info "Checking for Let's Encrypt certificates..."
if has_letsencrypt_cert; then
    # using letsencrypt so enable OCSP stapling
    log_info "Let's Encrypt certificate detected, enabling OCSP stapling"
    if [ ! -e "$OCPS_CONF" ]; then
        ln -s "${OCPS_CONF}.template" "$OCPS_CONF"
        log_info "OCSP stapling configuration linked"
    fi
else
    NEXTCLOUD_HTTPS_PORT=$IOCAGE_HOST_PORT_HTTPS
    log_info "No Let's Encrypt certificate, using port $NEXTCLOUD_HTTPS_PORT"
    # disable OCPS stapling
    rm -f "$OCPS_CONF"
fi

# Generate nginx configuration from the base template
SCHEME=https
if [ "${ALLOW_INSECURE_ACCESS:-false}" = "true" ]; 
then
    SCHEME=http
    log_info "ALLOW_INSECURE_ACCESS is true, using HTTP"
else
    log_info "Using HTTPS"
fi

log_info "Generating nginx configuration for $SCHEME..."
NEXTCLOUD_CONF="${NGINX_CONFD_PATH}/nextcloud.${SCHEME}.conf"
envsubst '$NEXTCLOUD_HTTPS_PORT' <"${NEXTCLOUD_CONF}.template" >"$NEXTCLOUD_CONF"
log_info "Nginx configuration generated: $NEXTCLOUD_CONF"

# Remove the opposite scheme configuration to avoid duplicate upstream errors
if [ "$SCHEME" = "https" ]; then
    rm -f "${NGINX_CONFD_PATH}/nextcloud.http.conf"
    log_info "Removed HTTP configuration to avoid duplicate upstream"
else
    rm -f "${NGINX_CONFD_PATH}/nextcloud.https.conf"
    log_info "Removed HTTPS configuration to avoid duplicate upstream"
fi

# Copy Nextcloud custom configuration
log_info "Copying Nextcloud custom configuration..."
cp /root/config/truenas.config.php /usr/local/www/nextcloud/config/truenas.config.php
chown -R www:www /usr/local/www/nextcloud/config
chmod -R u+rw /usr/local/www/nextcloud/config
log_info "Nextcloud configuration updated"

log_step_end "sync_configuration"
