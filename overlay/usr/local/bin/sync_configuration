#!/bin/sh

set -eu

. load_env

NGINX_CONFD_PATH=/usr/local/etc/nginx/conf.d
OCPS_CONF="${NGINX_CONFD_PATH}/ocps-stapling.conf"
CERT_PATH=/usr/local/etc/letsencrypt/live/truenas

# Copy PostgreSQL configuration if it exists
if [ -f /root/config/postgresql.conf ]; then
    cp /root/config/postgresql.conf /usr/local/etc/postgresql/data18/postgresql.conf 2>/dev/null || true
fi

# Copy Redis configuration if it exists and service is enabled
if [ -f /root/config/redis.conf ]; then
    cp /root/config/redis.conf /usr/local/etc/redis.conf 2>/dev/null || true
fi

# Two cases:
# - Nextcloud is accessed through <domain_name>: use port 443
# - Nextcloud is accessed through <ip>:<port>: use port $IOCAGE_HOST_PORT_HTTPS
export NEXTCLOUD_HTTPS_PORT=443

# Check if we have Let's Encrypt certificates by examining the certificate issuer
# This avoids calling certbot which logs debug messages on every invocation
has_letsencrypt_cert() {
    [ -f "${CERT_PATH}/fullchain.pem" ] && \
        openssl x509 -in "${CERT_PATH}/fullchain.pem" -issuer -noout 2>/dev/null | grep -qi "Let's Encrypt"
}

if has_letsencrypt_cert; then
    # using letsencrypt so enable OCSP stapling
    if [ ! -e "$OCPS_CONF" ]; then
        ln -s "${OCPS_CONF}.template" "$OCPS_CONF"
    fi
else
    NEXTCLOUD_HTTPS_PORT=$IOCAGE_HOST_PORT_HTTPS
    # disable OCPS stapling
    rm -f "$OCPS_CONF"
fi

# Generate nginx configuration from the base template
SCHEME=https
if [ "${ALLOW_INSECURE_ACCESS:-false}" = "true" ]; 
then
    SCHEME=http
fi

NEXTCLOUD_CONF="${NGINX_CONFD_PATH}/nextcloud.${SCHEME}.conf"
envsubst '$NEXTCLOUD_HTTPS_PORT' <"${NEXTCLOUD_CONF}.template" >"$NEXTCLOUD_CONF"

# Copy Nextcloud custom configuration
cp /root/config/truenas.config.php /usr/local/www/nextcloud/config/truenas.config.php
chown -R www:www /usr/local/www/nextcloud/config
chmod -R u+rw /usr/local/www/nextcloud/config
