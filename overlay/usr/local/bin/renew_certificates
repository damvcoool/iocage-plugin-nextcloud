#!/bin/sh

set -eu

CERT_PATH=/usr/local/etc/letsencrypt/live/truenas

# Check if we have Let's Encrypt certificates by examining the certificate issuer
# This avoids calling certbot which logs debug messages on every invocation
# Match various Let's Encrypt certificate authorities (R3, E1, etc.) and ISRG Root
has_letsencrypt_cert() {
	[ -f "${CERT_PATH}/fullchain.pem" ] && \
		openssl x509 -in "${CERT_PATH}/fullchain.pem" -issuer -noout 2>/dev/null | grep -qiE "Let's Encrypt|ISRG Root"
}

if has_letsencrypt_cert; then
	certbot renew -q
else
	# Limit self-signed certificate renewal to one month before expiration
	if [ -f "${CERT_PATH}/server.cer" ]; then
		if openssl x509 -in "${CERT_PATH}/server.cer" -checkend $(( 60*60*24*31 )) >/dev/null 2>&1; then
			exit 0
		fi
	fi

	generate_self_signed_tls_certificates
fi

service nginx restart
